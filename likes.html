<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>샤픽 - 호감</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            width: 100%;
            max-width: 420px;
            background-color: white;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            background: white;
            z-index: 10;
            flex-shrink: 0;
        }

        .page-title {
            font-size: 20px;
            font-weight: 800;
            margin: 0;
            color: #333;
        }

        .top-tabs {
            display: flex;
            padding: 10px 20px 0;
            border-bottom: 1px solid #eee;
            background: white;
            flex-shrink: 0;
        }

        .top-tab {
            flex: 1;
            text-align: center;
            padding: 10px 0;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

            .top-tab.active {
                color: #333;
                border-bottom: 2px solid #333;
            }

        .content-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: none;
        }

            .content-list.active {
                display: block;
            }

        .card {
            border: 1px solid #eee;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            position: relative;
        }

        .info-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .profile-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #eee;
            margin-right: 15px;
            object-fit: cover;
        }

        .msg-box {
            background: #fff0f6;
            padding: 10px;
            border-radius: 8px;
            font-size: 13px;
            color: #555;
            margin-bottom: 15px;
        }

        /* [NEW] 남은 시간 뱃지 */
        .time-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ffebeb;
            color: #ff6b6b;
            font-size: 11px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            font-size: 14px;
        }

        .btn-accept {
            background: #ff758c;
            color: white;
        }

        .btn-reject {
            background: #f1f3f5;
            color: #666;
        }

        .btn-kakao {
            width: 100%;
            background: #fee500;
            color: #3b1e1e;
            padding: 14px;
            border-radius: 12px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            font-size: 15px;
        }

        .btn-pay {
            background: #333;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: white;
            width: 85%;
            max-width: 300px;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
        }

        .kakao-id {
            font-size: 20px;
            font-weight: bold;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            user-select: all;
        }

        .tab-bar {
            background: white;
            border-top: 1px solid #eee;
            padding: 10px;
            display: flex;
            justify-content: space-around;
            height: 60px;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .tab-item {
            text-align: center;
            font-size: 11px;
            color: #888;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 33%;
        }

            .tab-item.active {
                color: #ff758c;
            }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="header">
            <h1 class="page-title">호감 & 매칭</h1>
        </header>

        <div class="top-tabs">
            <div class="top-tab active" onclick="switchTab('received')">받은 호감</div>
            <div class="top-tab" onclick="switchTab('matched')">성사된 매칭</div>
        </div>

        <div class="content-list active" id="list-received">
            <p style="text-align:center; color:#aaa; margin-top:50px;">로딩중...</p>
        </div>

        <div class="content-list" id="list-matched">
            <p style="text-align:center; color:#aaa; margin-top:50px;">로딩중...</p>
        </div>

        <nav class="tab-bar">
            <a href="matching.html" class="tab-item"><span style="display:block; font-size:20px;">🏠</span>홈</a>
            <div class="tab-item active"><span style="display:block; font-size:20px;">❤️</span>호감</div>
            <a href="mypage.html" class="tab-item"><span style="display:block; font-size:20px;">👤</span>마이</a>
        </nav>
    </div>

    <div id="kakaoModal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin:0;">매칭 성공!</h3>
            <p style="font-size:13px; color:#666; margin-top:5px;">상대방의 카카오톡 ID입니다.</p>
            <div class="kakao-id" id="modal-kakao-text">-</div>
            <button class="btn btn-reject" onclick="document.getElementById('kakaoModal').style.display='none'">닫기</button>
        </div>
    </div>

    <script>
        // -----------------------------------------------------------
        // [필수] 키 값 입력
        // -----------------------------------------------------------
        const PROJECT_URL = 'https://gmzvbgkxwzadpndeostq.supabase.co';
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdtenZiZ2t4d3phZHBuZGVvc3RxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyOTM3NTIsImV4cCI6MjA3OTg2OTc1Mn0.9VfVKumfVOPYDrwKvd4lyKjeUnKfGD5Z4v7k-Wfj140';
        // -----------------------------------------------------------

        const supabase = window.supabase.createClient(PROJECT_URL, API_KEY);

        let myId = null;
        let myGender = '';
        let myCoins = 0;

        async function init() {
            myId = localStorage.getItem('my_id');
            if (!myId) { alert("로그인 필요"); location.href = 'signup.html'; return; }

            const { data: me } = await supabase.from('users').select('*').eq('id', myId).single();
            if (me) {
                myGender = me.gender;
                myCoins = me.coins || 0;
                loadReceivedLikes();
                loadMatches();
            }
        }

        window.switchTab = function (tabName) {
            document.querySelectorAll('.top-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-list').forEach(l => l.classList.remove('active'));

            if (tabName === 'received') {
                document.querySelectorAll('.top-tab')[0].classList.add('active');
                document.getElementById('list-received').classList.add('active');
            } else {
                document.querySelectorAll('.top-tab')[1].classList.add('active');
                document.getElementById('list-matched').classList.add('active');
            }
        }

        // 1. 받은 호감 불러오기 (48시간 이내 필터링)
        async function loadReceivedLikes() {
            // [핵심 로직] 현재 시간에서 48시간을 뺀 시간 계산
            const now = new Date();
            const timeLimit = new Date(now.getTime() - (48 * 60 * 60 * 1000)); // 48시간 전

            const { data: likes, error } = await supabase
                .from('likes')
                .select('*, users!sender_id(*)')
                .eq('receiver_id', myId)
                .eq('status', 'pending')
                .gt('created_at', timeLimit.toISOString()) // 생성일이 48시간 전보다 큰 것만(=최근 48시간)
                .order('created_at', { ascending: false });

            const area = document.getElementById('list-received');
            area.innerHTML = '';

            if (error || !likes || likes.length === 0) {
                area.innerHTML = `
                        <div style="text-align:center; margin-top:50px;">
                            <i class="fa-regular fa-envelope-open" style="font-size:40px; color:#ddd; margin-bottom:15px;"></i>
                            <p style="color:#aaa;">도착한 호감이 없거나<br>48시간이 지나 만료되었습니다.</p>
                        </div>`;
                return;
            }

            likes.forEach(like => {
                const sender = like.users;
                const imgSrc = `https://source.unsplash.com/random/100x100/?person,${sender.gender === '여성' ? 'woman' : 'man'},${sender.id}`;

                // 남은 시간 계산
                const created = new Date(like.created_at);
                const expire = new Date(created.getTime() + (48 * 60 * 60 * 1000));
                const diffMs = expire - now;
                const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                const timeLeft = diffHrs > 0 ? `${diffHrs}시간 남음` : "곧 만료됨";

                const html = `
                        <div class="card">
                            <div class="time-badge"><i class="fa-regular fa-clock"></i> ${timeLeft}</div>
                            <div class="info-row">
                                <img src="${imgSrc}" class="profile-pic">
                                <div>
                                    <h3 style="margin:0;">${sender.nickname} <span style="font-size:13px; font-weight:normal;">${sender.birth_year ? sender.birth_year.slice(2, 4) : '00'}년생</span></h3>
                                    <p style="margin:0; font-size:13px; color:#888;">${sender.university} · ${sender.mbti}</p>
                                </div>
                            </div>
                            ${like.message ? `<div class="msg-box">"${like.message}"</div>` : ''}
                            <div class="btn-group">
                                <button class="btn btn-reject" onclick="respondLike(${like.id}, 'rejected')">거절</button>
                                <button class="btn btn-accept" onclick="respondLike(${like.id}, 'accepted', '${sender.nickname}')">수락하기</button>
                            </div>
                        </div>
                    `;
                area.innerHTML += html;
            });
        }

        // 수락/거절
        window.respondLike = async function (likeId, newStatus, senderName) {
            let msg = newStatus === 'accepted' ? "수락하시겠습니까?" : "거절하시겠습니까?";
            if (!confirm(msg)) return;

            const { error } = await supabase.from('likes').update({ status: newStatus }).eq('id', likeId);

            if (error) alert("오류 발생");
            else {
                if (newStatus === 'accepted') {
                    if (myGender === '여성') alert(`수락하셨습니다! 😊\n상대방(남성)이 결제하면 연락처가 공개됩니다.`);
                    else alert(`수락하셨습니다! 😊\n[성사된 매칭] 탭에서 결제 후 연락처를 확인하세요.`);
                }
                location.reload();
            }
        }

        // 2. 성사된 매칭 불러오기 (비즈니스 로직 적용)
        async function loadMatches() {
            const { data: matches } = await supabase
                .from('likes')
                .select('*')
                .or(`sender_id.eq.${myId},receiver_id.eq.${myId}`)
                .eq('status', 'accepted');

            const area = document.getElementById('list-matched');
            area.innerHTML = '';

            if (!matches || matches.length === 0) {
                area.innerHTML = '<p style="text-align:center; color:#aaa; margin-top:50px;">성사된 매칭이 없습니다.</p>';
                return;
            }

            for (const match of matches) {
                const partnerId = match.sender_id === myId ? match.receiver_id : match.sender_id;
                const { data: partner } = await supabase.from('users').select('*').eq('id', partnerId).single();

                if (!partner) continue;

                const isPaid = match.is_paid;
                const imgSrc = `https://source.unsplash.com/random/100x100/?person,${partner.gender === '여성' ? 'woman' : 'man'},${partner.id}`;
                let btnHtml = '';

                // [핵심] 성별에 따른 노출 로직 (여자는 남자가 결제 안 했으면 숨김)
                if (myGender === '남성') {
                    if (isPaid) {
                        btnHtml = `<button class="btn-kakao" onclick="showKakao('${partner.kakao_id}')">카톡 ID 확인하기</button>`;
                    } else {
                        btnHtml = `<button class="btn-kakao btn-pay" onclick="payAndShow('${match.id}', '${partner.kakao_id}')">🔒 5코인으로 연락처 열기</button>`;
                    }
                } else {
                    if (isPaid) {
                        btnHtml = `<button class="btn-kakao" onclick="showKakao('${partner.kakao_id}')">카톡 ID 확인하기</button>`;
                    } else {
                        continue; // 남자가 결제 안 했으므로 화면에 안 그림 (숨김)
                    }
                }

                const html = `
                        <div class="card">
                            <div class="info-row">
                                <img src="${imgSrc}" class="profile-pic">
                                <div>
                                    <h3 style="margin:0;">${partner.nickname}</h3>
                                    <p style="margin:0; font-size:13px; color:#888;">${partner.university}</p>
                                </div>
                            </div>
                            ${btnHtml}
                        </div>
                    `;
                area.innerHTML += html;
            }

            if (area.innerHTML === '') {
                area.innerHTML = '<p style="text-align:center; color:#aaa; margin-top:50px;">연락처가 공개된 매칭이 없습니다.<br>(상대방의 결제를 기다리고 있어요)</p>';
            }
        }

        window.payAndShow = async function (matchId, kakaoId) {
            if (myCoins < 5) { alert("코인이 부족합니다! (필요: 5, 보유: " + myCoins + ")"); return; }

            if (confirm("5코인을 사용하여 연락처를 확인하시겠습니까?\n(상대방에게도 내 연락처가 공개됩니다)")) {
                const { error: coinErr } = await supabase.from('users').update({ coins: myCoins - 5 }).eq('id', myId);
                if (coinErr) { alert("오류 발생"); return; }

                await supabase.from('likes').update({ is_paid: true }).eq('id', matchId);

                alert("결제 완료! 연락처가 공개됩니다.");
                showKakao(kakaoId);
                location.reload();
            }
        }

        window.showKakao = function (id) {
            document.getElementById('modal-kakao-text').innerText = id || "ID 정보 없음";
            document.getElementById('kakaoModal').style.display = 'flex';
        }

        init();
    </script>
</body>
</html>